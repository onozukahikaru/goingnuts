{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
PRODUCT INVENTORY COMPONENT
----------------------------------------------------------------------------------------------------------------------

This component is used to display the inventory of a given product

********************************************
Supported variables
********************************************

* product: the product from which the inventory is extracted (if none is set, a placeholder is rendered)
* show_in_stock_quantity: decide if the quantity in stock is shown or not
* low_threshold: the inventory quantity threshold below which the inventory is shown as "red"
* show_progress_bar: if true, a progress bar is added
* progress_bar_max_value: the value used as a max value to calculate the progress advancement
* form_id: if specified, define the form ID linked to this input
{%- endcomment -%}

{%- capture inventory_for_variants -%}
  {%- assign inventory_default_status = '' -%}
  {%- assign inventory_default_quantity = '' -%}

  {%- if product -%}
    {%- for variant in product.variants -%}
{%- comment -%} Wholesale_Club_Product_Visibility_For_Loop Start {%- endcomment -%}
{%- capture hide_resource -%}{% render "wc_product_visibility", resource: variant %}{%- endcapture -%}
{%- if hide_resource == "true" -%}
  {% continue %}
{%- endif -%}
{%- comment -%} Wholesale_Club_Product_Visibility_For_Loop End {%- endcomment -%}

{% comment %} Wholesale_Club_Product_Prices Start {% endcomment %}
{% assign base_product = product %}
{% assign base_variant = variant %}

{% if shop.metafields.sawholesale['base_price'] == blank %}
  {% assign base_price = 'compare_at_price' %}
{% else %}
  {% assign base_price = shop.metafields.sawholesale['base_price'] %}
{% endif %}

{% assign saw_discount = 0 %}{% assign saw_has_discount = false %}

{% if customer.tags != blank %}
  {% for mf in base_product.metafields.sawholesale %}
{%- comment -%} Wholesale_Club_Product_Visibility_For_Loop Start {%- endcomment -%}
{%- capture hide_resource -%}{% render "wc_product_visibility", resource: mf %}{%- endcapture -%}
{%- if hide_resource == "true" -%}
  {% continue %}
{%- endif -%}
{%- comment -%} Wholesale_Club_Product_Visibility_For_Loop End {%- endcomment -%}

    {% capture product_customer_tag %}{{ mf | first | replace: 'discount_', '' }}{% endcapture %}
    {% if customer.tags contains product_customer_tag %}
      {% assign saw_has_discount = true %}
      {% assign discount_key = product_customer_tag | prepend: 'discount_' %}
      {% assign price_key = product_customer_tag | prepend: 'price_' %}
      {% assign saw_discount = base_product.metafields.sawholesale[discount_key] | divided_by: 100.0 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% assign saw_discount = 1 | minus: saw_discount %}

{% if base_price == 'price' or base_variant.compare_at_price == blank  or base_variant.compare_at_price == 0 or base_variant.compare_at_price < base_variant.price %}
  {% assign saw_variant_compare_at_price = base_variant.price %}
{% else %}
  {% assign saw_variant_compare_at_price = base_variant.compare_at_price %}
{% endif %}

{% assign cpe = shop.metafields.sawholesale['cpe'] | default: "true" %}
{% if base_variant.metafields.sawholesale[price_key] != blank and cpe == "true" %}
  {% assign saw_variant_price = base_variant.metafields.sawholesale[price_key] %}
{% else %}
  {% assign saw_variant_price = saw_variant_compare_at_price | times: saw_discount %}
{% endif %}

{% if saw_has_discount == false or saw_variant_price >= saw_variant_compare_at_price %}
  {% assign WCProduct_Price = base_product.price %}
  {% assign WCProduct_ComparePrice = base_product.compare_at_price %}
  {% assign WCProduct_PriceMin = base_product.price_min %}
  {% assign WCProduct_ComparePriceMin = base_product.compare_at_price_min %}
  {% assign WCProduct_PriceMax = base_product.price_max %}
  {% assign WCProduct_ComparePriceMax = base_product.compare_at_price_max %}
  {% assign WCProduct_VariantPrice = base_variant.price %}
  {% assign WCProduct_VariantComparePrice = base_variant.compare_at_price %}
{% else %}   
  {% assign WCProduct_Price = saw_variant_price %}
  {% assign WCProduct_PriceMin = base_product.price_min | times: saw_discount %}
  {% assign WCProduct_PriceMax = base_product.price_max | times: saw_discount %}
  {% assign WCProduct_ComparePrice = saw_variant_compare_at_price %}
  {% if base_product.compare_at_price_min != 0 %}{% assign WCProduct_ComparePriceMin = base_product.compare_at_price_min %}{% else %}{% assign WCProduct_ComparePriceMin = base_product.price_min %}{% endif %}
  {% if base_product.compare_at_price_max != 0 %}{% assign WCProduct_ComparePriceMax = base_product.compare_at_price_max %}{% else %}{% assign WCProduct_ComparePriceMax = base_product.price_max %}{% endif %}
  {% assign WCProduct_VariantPrice = saw_variant_price %}
  {% assign WCProduct_VariantComparePrice = saw_variant_compare_at_price %}
{% endif %}
{% comment %} Wholesale_Club_Product_Prices End {% endcomment %}

      {%- liquid
        if variant.available
          if variant.inventory_management and variant.inventory_policy == 'deny' and variant.inventory_quantity <= low_threshold and low_threshold > 0
            assign inventory_status = 'warning'
            assign inventory_text = 'product.inventory.low_stock_with_quantity_count' | t: count: variant.inventory_quantity
          else
            if variant.inventory_policy == 'continue' and variant.inventory_quantity <= 0 and variant.requires_shipping
              if variant.incoming and variant.next_incoming_date
                assign next_incoming_date = variant.next_incoming_date | date: format: 'date'
                assign inventory_status = 'warning'
                assign inventory_text = 'product.inventory.incoming_stock' | t: next_incoming_date: next_incoming_date
              else
                assign inventory_status = 'warning'
                assign inventory_text = 'product.inventory.oversell_stock' | t
              endif
            else
              assign inventory_status = 'success'

              if show_in_stock_quantity and variant.inventory_management
                assign inventory_text = 'product.inventory.in_stock_with_quantity_count' | t: count: variant.inventory_quantity
              else
                assign inventory_text = 'product.inventory.in_stock' | t
              endif
            endif
          endif
        elsif variant.incoming
          if variant.next_incoming_date
            assign next_incoming_date = variant.next_incoming_date | date: format: 'date'
            assign inventory_status = 'warning'
            assign inventory_text = 'product.inventory.incoming_stock' | t: next_incoming_date: next_incoming_date
          else
            assign inventory_status = 'warning'
            assign inventory_text = 'product.inventory.oversell_stock' | t
          endif
        else
          assign inventory_status = 'error'
          assign inventory_text = 'product.inventory.out_of_stock' | t
        endif

        if variant == product.selected_or_first_available_variant
          assign inventory_default_status = inventory_status

          if variant.inventory_management
            assign inventory_default_quantity = variant.inventory_quantity | at_least: 0
          else
            assign inventory_default_quantity = progress_bar_max_value
          endif
        endif
      -%}

      <span {% unless variant == product.selected_or_first_available_variant %}hidden{% endunless %} data-variant-id="{{ variant.id }}" {% if show_progress_bar %}data-quantity="{% if variant.inventory_management %}{{ variant.inventory_quantity | at_least: 0 }}{% else %}{{ progress_bar_max_value }}{% endif %}"{% endif %} data-status="{{ inventory_status }}">
        {{- inventory_text -}}
      </span>
    {%- endfor -%}
  {%- else -%}
    <span data-status="success">
      {%- if show_in_stock_quantity -%}
        {{- 'product.inventory.in_stock_with_quantity_count' | t: count: variant.inventory_quantity -}}
      {%- else -%}
        {{- 'product.inventory.in_stock' | t -}}
      {%- endif -%}
    </span>
  {%- endif -%}
{%- endcapture -%}

{%- if inventory_for_variants != blank -%}
  <variant-inventory class="inventory text-{{ inventory_default_status }}" {% if form_id %}form="{{ form_id }}"{% endif %}>
    {{- inventory_for_variants -}}

    {%- if show_progress_bar -%}
      <progress-bar class="progress-bar" animate-on-scroll aria-valuenow="{{ inventory_default_quantity }}" aria-valuemax="{{ progress_bar_max_value | default: 50 }}"></progress-bar>
    {%- endif -%}
  </variant-inventory>
{%- endif -%}